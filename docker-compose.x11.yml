version: '3.8'

services:
  # é–‹ç™¼å’Œæ§‹å»ºæœå‹™ï¼ˆæ•´åˆæˆåŠŸçš„ X11 è§£æ±ºæ–¹æ¡ˆï¼‰
  urology-dev-x11:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    container_name: urology-dev-x11
    working_dir: /workspace
    volumes:
      - .:/workspace
      - ./data:/workspace/data
      # X11 æ”¯æŒï¼ˆä½¿ç”¨æˆåŠŸçš„é…ç½®ï¼‰
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ${XAUTH:-/tmp/.docker.xauth.urology}:${XAUTH:-/tmp/.docker.xauth.urology}:rw
      # nvidia_icd.json æ”¯æŒ
      - /usr/share/vulkan/icd.d/nvidia_icd.json:/usr/share/vulkan/icd.d/nvidia_icd.json:ro
    environment:
      - DISPLAY=${DISPLAY:-localhost:10.0}
      - XAUTHORITY=${XAUTH:-/tmp/.docker.xauth.urology}
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=graphics,video,compute,utility,display
      # OpenGL é–“æ¥æ¸²æŸ“ï¼ˆSSH ç’°å¢ƒï¼‰
      - LIBGL_ALWAYS_INDIRECT=1
      - MESA_GL_VERSION_OVERRIDE=3.3
      # ç·¨è­¯å™¨è¨­ç½®
      - CMAKE_C_COMPILER=/usr/bin/gcc
      - CMAKE_CXX_COMPILER=/usr/bin/g++
      - CC=/usr/bin/gcc
      - CXX=/usr/bin/g++
    network_mode: host
    ipc: host
    pid: host
    stdin_open: true
    tty: true
    cap_add:
      - CAP_SYS_PTRACE
    security_opt:
      - seccomp:unconfined
    ulimits:
      memlock: -1
    command: >
      bash -c "
      echo '=== Urology Inference é–‹ç™¼ç’°å¢ƒï¼ˆå®Œæ•´ X11 æ”¯æŒï¼‰===' &&
      echo 'ğŸ“‹ ç’°å¢ƒæª¢æŸ¥ï¼š' &&
      echo 'DISPLAY=' \$DISPLAY &&
      echo 'XAUTHORITY=' \$XAUTHORITY &&
      echo 'OpenCV ç‰ˆæœ¬ï¼š' \$(pkg-config --modversion opencv4) &&
      echo 'Holoscan ç‰ˆæœ¬ï¼š3.3.0' &&
      echo '' &&
      echo 'ğŸ§ª å®‰è£ X11 æ¸¬è©¦å·¥å…·...' &&
      apt update -qq && apt install -y x11-apps xauth &&
      echo '' &&
      echo 'ğŸ¯ æ¸¬è©¦ X11 é€£æ¥...' &&
      echo 'æª¢æŸ¥ X11 socket:' &&
      ls -la /tmp/.X11-unix/ || echo 'âŒ X11 socket ä¸å­˜åœ¨' &&
      echo '' &&
      echo 'æª¢æŸ¥èªè­‰æ–‡ä»¶:' &&
      ls -la \$XAUTHORITY || echo 'âŒ èªè­‰æ–‡ä»¶ä¸å­˜åœ¨' &&
      echo '' &&
      echo 'æ¸¬è©¦ xauth:' &&
      xauth list 2>/dev/null || echo 'âš ï¸  xauth åˆ—è¡¨ç‚ºç©º' &&
      echo '' &&
      echo 'æ¸¬è©¦ X11 æ‡‰ç”¨:' &&
      timeout 3 xeyes 2>/dev/null & XEYES_PID=\$! &&
      sleep 1 &&
      if kill -0 \$XEYES_PID 2>/dev/null; then
          echo 'âœ… X11 é€£æ¥æˆåŠŸï¼xeyes æ­£åœ¨é‹è¡Œ' &&
          kill \$XEYES_PID 2>/dev/null || true
      else
          echo 'âŒ xeyes å•Ÿå‹•å¤±æ•—'
      fi &&
      echo '' &&
      echo 'ğŸ¯ æ¸¬è©¦ Holoscan Hello World...' &&
      /opt/nvidia/holoscan/examples/hello_world/cpp/hello_world &&
      echo '' &&
      echo 'ğŸ”¨ æ§‹å»ºé …ç›®...' &&
      chmod 755 /workspace &&
      mkdir -p build && cd build &&
      if cmake .. && make -j\$(nproc); then
          echo 'âœ… é …ç›®æ§‹å»ºæˆåŠŸï¼' &&
          echo '' &&
          echo 'ğŸ¯ å¯ç”¨çš„é‹è¡Œé¸é …ï¼š' &&
          echo '' &&
          echo 'ğŸ–¥ï¸  å®Œæ•´ UI æ¨¡å¼ï¼ˆX11 é¡¯ç¤ºï¼‰ï¼š' &&
          echo './urology_inference_holoscan_cpp --data=../data' &&
          echo '' &&
          echo 'ğŸ–¥ï¸  Headless æ¨¡å¼ï¼ˆç„¡ UIï¼‰ï¼š' &&
          echo 'HOLOVIZ_HEADLESS=1 ./urology_inference_holoscan_cpp --data=../data' &&
          echo '' &&
          echo 'ğŸ§ª ç°¡åŒ–æ¸¬è©¦ï¼š' &&
          echo './simple_inference_test' &&
          echo '' &&
          echo 'ğŸ“ å¯ç”¨çš„åŸ·è¡Œæ–‡ä»¶ï¼š' &&
          ls -la *urology* *simple* *hello* 2>/dev/null || echo 'ç„¡åŸ·è¡Œæ–‡ä»¶' &&
          chown -R 1007:100 /workspace/build/ 2>/dev/null || true
      else
          echo 'âŒ é …ç›®æ§‹å»ºå¤±æ•—'
      fi &&
      echo '' &&
      echo 'ğŸ¯ é–‹ç™¼ç’°å¢ƒå·²æº–å‚™å°±ç·’ï¼' &&
      bash
      "
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  # é‹è¡Œæœå‹™ï¼ˆX11 UI æ¨¡å¼ï¼‰
  urology-run-x11:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    container_name: urology-run-x11
    working_dir: /workspace
    volumes:
      - .:/workspace
      - ./data:/workspace/data
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ${XAUTH:-/tmp/.docker.xauth.urology}:${XAUTH:-/tmp/.docker.xauth.urology}:rw
      - /usr/share/vulkan/icd.d/nvidia_icd.json:/usr/share/vulkan/icd.d/nvidia_icd.json:ro
    environment:
      - DISPLAY=${DISPLAY:-localhost:10.0}
      - XAUTHORITY=${XAUTH:-/tmp/.docker.xauth.urology}
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=graphics,video,compute,utility,display
      - LIBGL_ALWAYS_INDIRECT=1
      - MESA_GL_VERSION_OVERRIDE=3.3
    network_mode: host
    ipc: host
    pid: host
    cap_add:
      - CAP_SYS_PTRACE
    security_opt:
      - seccomp:unconfined
    ulimits:
      memlock: -1
    depends_on:
      - urology-dev-x11
    command: >
      bash -c "
      echo 'ğŸ¯ é‹è¡Œ Urology Inferenceï¼ˆX11 UI æ¨¡å¼ï¼‰...' &&
      cd /workspace/build &&
      ./urology_inference_holoscan_cpp --data=../data
      "
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  # é‹è¡Œæœå‹™ï¼ˆHeadless æ¨¡å¼ï¼‰
  urology-run-headless:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    container_name: urology-run-headless
    working_dir: /workspace
    volumes:
      - .:/workspace
      - ./data:/workspace/data
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
      - HOLOVIZ_HEADLESS=1
    depends_on:
      - urology-dev-x11
    command: >
      bash -c "
      echo 'ğŸ¯ é‹è¡Œ Urology Inferenceï¼ˆHeadless æ¨¡å¼ï¼‰...' &&
      cd /workspace/build &&
      HOLOVIZ_HEADLESS=1 ./urology_inference_holoscan_cpp --data=../data
      "
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

# Networks
networks:
  urology-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# Volumes
volumes:
  urology_logs:
    driver: local
  urology_output:
    driver: local
  urology_build_cache:
    driver: local
  urology_ccache:
    driver: local 